<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Work Hours Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif;
      background: #050814;
      color: #f5f6fa;
    }

    main { max-width: 960px; margin: 0 auto; padding: 1rem; }

    .card {
      background: #111827;
      border-radius: 1rem;
      padding: 1rem 1.25rem;
      margin-bottom: 1rem;
      box-shadow: 0 12px 30px rgba(0,0,0,.45);
    }

    h1 { font-size: 1.6rem; margin: 0 0 .5rem; }
    h2 { font-size: 1.1rem; margin: 0 0 .4rem; }
    p { margin: 0; }

    .badge {
      display: inline-block;
      padding: .25rem .75rem;
      border-radius: 999px;
      font-weight: 700;
      font-size: .9rem;
    }
    .red   { background:#3b0b16; color:#ff6b81; }
    .yellow{ background:#3b2e08; color:#ffeaa7; }
    .green { background:#052a1a; color:#55efc4; }

    .muted { opacity:.75; font-size:.85rem; }

    .week-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px,1fr));
      gap: .5rem;
    }

    .day-card {
      background:#1f2937;
      border-radius:.75rem;
      padding:.55rem .75rem;
    }
    .day-card label {
      display:block; font-size:.8rem; opacity:.85; margin-bottom:.25rem;
    }
    .day-card input {
      width:100%;
      padding:.4rem .5rem;
      border-radius:.5rem;
      border:1px solid #374151;
      background:#050814; color:#f5f6fa; font-size:.95rem;
    }

    .summary-row {
      display:flex; flex-wrap:wrap; gap:.6rem;
      align-items:center; justify-content:space-between;
      margin-top:.75rem; font-size:.95rem;
    }

    button {
      border:none; border-radius:.75rem;
      padding:.55rem .95rem;
      font-weight:700; font-size:.95rem;
      background:#2563eb; color:#fff; cursor:pointer;
      box-shadow:0 6px 14px rgba(0,0,0,.45);
    }
    button:disabled { opacity:.5; cursor:default; box-shadow:none; }

    table { width:100%; border-collapse:collapse; font-size:.86rem; }
    th, td { padding:.35rem .45rem; border-bottom:1px solid #252b3b; text-align:left; white-space:nowrap; }
    th { font-weight:700; opacity:.85; }

    @media (max-width:600px) {
      h1 { font-size:1.35rem; }
      .card { padding:.9rem; }
    }
  </style>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
<main>
  <header class="card">
    <h1>Work Hours Tracker</h1>
    <p class="muted" style="margin-bottom:.5rem">
      Target: <strong>20 h / week</strong>.
      Bank updates <strong>only up to last Friday</strong>. Current week is shown but not counted.
    </p>
    <div id="bankBadge" class="badge yellow">Loading…</div>
    <div class="muted" id="bankNote" style="margin-left:.5rem; display:inline-block"></div>
  </header>

  <section class="card">
    <h2 id="currentTitle">This week (not counted)</h2>
    <div id="weekGrid" class="week-grid"></div>
    <div class="summary-row">
      <div>
        <div>Worked this week: <strong><span id="weekTotal">0</span> h</strong></div>
        <div id="weekHelp" class="muted"></div>
      </div>
      <button id="saveBtn" disabled>Save changes</button>
    </div>
  </section>

  <section class="card">
    <h2>Past weeks (counted up to last Friday)</h2>
    <table>
      <thead>
      <tr>
        <th>W#</th>
        <th>Week (Mon–Fri)</th>
        <th>Total</th>
        <th>Δ vs 20h</th>
        <th>Bank after week</th>
      </tr>
      </thead>
      <tbody id="historyBody">
      <tr><td colspan="5">Loading…</td></tr>
      </tbody>
    </table>
  </section>
</main>

<script>
  /* ------------------------- SUPABASE CONFIG ------------------------- */
  const supabaseUrl = 'https://pmapkowimesplgbvrook.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBtYXBrb3dpbWVzcGxnYnZyb29rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4MTUwNzYsImV4cCI6MjA3ODM5MTA3Nn0.5_jdBZfEHMq4thAe9UnmDOzAhQRq_9QclnEIjbaoj0M';
  const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
  /* ------------------------------------------------------------------ */

  const TARGET = 20;

  const bankBadge  = document.getElementById('bankBadge');
  const bankNote   = document.getElementById('bankNote');
  const historyT   = document.getElementById('historyBody');
  const weekGrid   = document.getElementById('weekGrid');
  const weekTotalE = document.getElementById('weekTotal');
  const weekHelp   = document.getElementById('weekHelp');
  const saveBtn    = document.getElementById('saveBtn');
  const currentTitle = document.getElementById('currentTitle');

  let allDays = {};       // 'YYYY-MM-DD' -> number
  let dirty = false;

  /* ---------------------------- DATE HELPERS ---------------------------- */
  function atMidnight(d){ const x=new Date(d); x.setHours(0,0,0,0); return x; }
  function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
  function getMonday(d) {
    const x = atMidnight(d);
    const day = x.getDay(); // 0 Sun, 1 Mon ... 6 Sat
    const diff = (day === 0 ? -6 : 1) - day;
    return addDays(x, diff);
  }
  function fridayOfWeek(d){ return addDays(getMonday(d), 4); }
  function lastFriday(today) {
    const fri = fridayOfWeek(today);
    // If we're past Friday (Sat or Sun), last Friday is this week's Friday.
    // Otherwise (Mon–Fri), last Friday is previous week's Friday.
    if (atMidnight(today) > fri) return fri;
    return addDays(fri, -7);
  }
  function formatDate(d){ return d.toISOString().slice(0,10); }

  /* ---------------------------- GROUP BY WEEKS --------------------------- */
  function groupWeeks(daysObj) {
    // Build week buckets keyed by Monday date string
    const dates = Object.keys(daysObj).sort(); // ascending
    const weeks = new Map(); // key: mondayStr -> { monDate, friDate, total, days:[] }
    for (const ds of dates) {
      const d = new Date(ds + 'T00:00:00');
      const mon = getMonday(d);
      const fri = addDays(mon,4);
      const key = formatDate(mon);
      if (!weeks.has(key)) weeks.set(key, { mon, fri, days: [], total: 0 });
      const hours = Number(daysObj[ds]) || 0;
      weeks.get(key).days.push({ date: ds, hours });
      weeks.get(key).total += hours;
    }
    // Sort by friday ascending
    return Array.from(weeks.values()).sort((a,b)=>a.fri-b.fri);
  }

  function computeBankUntilLastFriday(weeks, anchorFriday) {
    // Only include weeks whose Friday <= anchorFriday
    const included = weeks.filter(w => atMidnight(w.fri) <= atMidnight(anchorFriday));

    // Compute cumulative bank; label reverse W# with W1 = most recent included week
    let bank = 0;
    included.forEach(w => {
      w.delta = w.total - TARGET;
      bank += w.delta;
      w.bankAfter = bank;
    });

    // We want W1 = last Friday's week, then W2, ... going backwards
    const desc = [...included].sort((a,b)=>b.fri-a.fri);
    desc.forEach((w, idx)=> w.wIndex = idx + 1);

    return { included, latestDesc: desc, finalBank: bank };
  }

  /* ---------------------------- UI BUILDERS ----------------------------- */
  function buildCurrentWeek() {
    // Current week inputs (never counted in bank)
    const today = new Date();
    const mon = getMonday(today);
    const fri = addDays(mon,4);

    currentTitle.textContent = `This week (Mon ${mon.toLocaleDateString()} – Fri ${fri.toLocaleDateString()}) — not counted`;

    weekGrid.innerHTML = '';
    const dayNames = ['Mon','Tue','Wed','Thu','Fri'];
    let sum = 0;

    for (let i=0;i<5;i++) {
      const d = addDays(mon,i);
      const ds = formatDate(d);
      const hours = allDays[ds] ?? '';

      const card = document.createElement('div');
      card.className = 'day-card';
      card.innerHTML = `
        <label>${dayNames[i]} <span class="muted">(${ds})</span></label>
        <input type="number" step="0.25" min="0" inputmode="decimal" value="${hours}">
      `;
      const input = card.querySelector('input');
      input.addEventListener('input', ()=>{
        dirty = true; saveBtn.disabled = false;
        const v = input.value === '' ? null : Number(input.value);
        if (v === null || isNaN(v)) delete allDays[ds];
        else allDays[ds] = v;
        buildCurrentWeek(); // recompute this week's sum
      });
      weekGrid.appendChild(card);

      const h = Number(hours);
      if (!Number.isNaN(h)) sum += h;
    }

    weekTotalE.textContent = sum.toFixed(2).replace(/\.00$/,'');
    const diff = sum - TARGET;
    weekHelp.textContent =
      diff === 0 ? 'Exactly at 20h this week (not counted).'
      : diff > 0 ? `+${diff.toFixed(2)}h over target (not counted).`
                 : `${(-diff).toFixed(2)}h to go (not counted).`;
  }

  function buildHistoryAndBank() {
    const anchor = lastFriday(new Date()); // the last Friday boundary
    const weeks = groupWeeks(allDays);
    const { included, latestDesc, finalBank } = computeBankUntilLastFriday(weeks, anchor);

    // Bank badge
    bankNote.textContent = `(through ${anchor.toLocaleDateString()})`;
    const cls = finalBank < 0 ? 'badge red' : finalBank === 0 ? 'badge yellow' : 'badge green';
    bankBadge.className = cls;
    bankBadge.textContent =
      finalBank < 0 ? `${finalBank.toFixed(2)} h in debt`
      : finalBank === 0 ? '0 h in bank'
      : `+${finalBank.toFixed(2)} h in bank`;

    // History table: show W1 (last Friday’s week) first
    historyT.innerHTML = '';
    if (!latestDesc.length) {
      historyT.innerHTML = '<tr><td colspan="5">No past weeks yet.</td></tr>';
      return;
    }

    for (const w of latestDesc) {
      const end = w.fri;
      const start = w.mon;
      const tr = document.createElement('tr');
      const weekLabel = `${start.toLocaleDateString()} – ${end.toLocaleDateString()}`;
      const deltaStr = (w.delta >= 0 ? '+' : '') + w.delta.toFixed(2);
      const bankStr  = (w.bankAfter >= 0 ? '+' : '') + w.bankAfter.toFixed(2);
      tr.innerHTML = `
        <td>W${w.wIndex}</td>
        <td>${weekLabel}</td>
        <td>${w.total.toFixed(2)}</td>
        <td>${deltaStr}</td>
        <td>${bankStr}</td>
      `;
      historyT.appendChild(tr);
    }
  }

  /* ------------------------------ SAVE/LOAD ----------------------------- */
  async function loadAll() {
    const { data, error } = await supabaseClient
      .from('work_log')
      .select('work_date, hours')
      .order('work_date', { ascending: true });

    if (error) {
      console.error('Supabase error:', error);
      historyT.innerHTML = `<tr><td colspan="5">${error.message}</td></tr>`;
      bankBadge.className = 'badge red';
      bankBadge.textContent = 'Error';
      bankNote.textContent = '';
      return;
    }

    allDays = {};
    data.forEach(r => allDays[r.work_date] = Number(r.hours));
    buildCurrentWeek();
    buildHistoryAndBank();
  }

  async function saveCurrentWeek() {
    saveBtn.disabled = true;

    const today = new Date();
    const mon = getMonday(today);
    const rows = [];
    for (let i=0;i<5;i++) {
      const ds = formatDate(addDays(mon,i));
      const v = allDays[ds];
      if (typeof v === 'number' && !Number.isNaN(v)) rows.push({ work_date: ds, hours: v });
    }

    const { error } = await supabaseClient.from('work_log')
      .upsert(rows, { onConflict: 'work_date' });

    if (error) {
      console.error('Supabase save error:', error);
      alert('Error saving: ' + error.message);
      saveBtn.disabled = false;
      return;
    }
    dirty = false;
    await loadAll();
  }

  saveBtn.addEventListener('click', saveCurrentWeek);

  window.addEventListener('beforeunload', (e)=>{
    if (!dirty) return;
    e.preventDefault(); e.returnValue = '';
  });

  loadAll();
</script>
</body>
</html>
